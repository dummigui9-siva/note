<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Advanced Notes App</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,sans-serif;
    background:#f2f2f2;
    transition:0.3s;
}
body.dark{
    background:#1e1e1e;
    color:white;
}

/* AUTH */
.auth-container{
    display:flex;
    height:100vh;
    justify-content:center;
    align-items:center;
}
.auth-box{
    background:white;
    padding:30px;
    width:320px;
    border-radius:12px;
    box-shadow:0 10px 25px rgba(0,0,0,0.1);
}
body.dark .auth-box{
    background:#2a2a2a;
    color:white;
}
.auth-box input{
    width:100%;
    padding:10px;
    margin:8px 0;
    border-radius:6px;
    border:1px solid #ccc;
}
.auth-box button{
    width:100%;
    padding:10px;
    margin-top:8px;
    background:#007bff;
    border:none;
    color:white;
    border-radius:6px;
    cursor:pointer;
}
.auth-box p{
    text-align:center;
    cursor:pointer;
    color:#007bff;
    font-size:14px;
}

/* APP */
#app{ display:none; }

.topbar{
    background:#007bff;
    color:white;
    padding:12px 20px;
    display:flex;
    justify-content:space-between;
    align-items:center;
}

.controls{
    padding:15px 20px;
}
.controls button{
    margin-right:10px;
    padding:8px 12px;
}
.controls input{
    padding:6px;
}

.notes-container{
    padding:20px;
    display:flex;
    flex-wrap:wrap;
    gap:15px;
}

.note{
    width:220px;
    min-height:170px;
    padding:10px;
    border-radius:10px;
    box-shadow:0 5px 15px rgba(0,0,0,0.15);
    position:relative;
    cursor:grab;
}
body.dark .note{
    box-shadow:0 5px 15px rgba(255,255,255,0.1);
}
.note textarea{
    width:100%;
    border:none;
    background:transparent;
    resize:none;
    height:100px;
    outline:none;
}
body.dark textarea{ color:white; }

.note input[type="color"]{
    margin-top:5px;
}
.note .actions{
    position:absolute;
    bottom:5px;
    right:5px;
}
.note button{
    border:none;
    background:none;
    cursor:pointer;
    font-size:16px;
}
</style>
</head>

<body>

<div class="auth-container" id="authContainer">
    <div class="auth-box" id="loginBox">
        <h2>Login</h2>
        <input id="loginUser" placeholder="Username">
        <input id="loginPass" type="password" placeholder="Password">
        <button onclick="login()">Login</button>

        <button onclick="document.getElementById('globalImportFile').click()">
        Import Backup
        </button>
        <input type="file" id="globalImportFile"
        onchange="globalImport(event)" hidden>

        <p onclick="showRegister()">Register</p>
        <p onclick="showForgot()">Forgot Password</p>
    </div>

    <div class="auth-box" id="registerBox" style="display:none;">
        <h2>Register</h2>
        <input id="regUser" placeholder="Username">
        <input id="regPass" type="password" placeholder="Password">
        <input id="regCode" placeholder="Passcode (Recovery)">
        <button onclick="register()">Register</button>
        <p onclick="showLogin()">Back to Login</p>
    </div>

    <div class="auth-box" id="forgotBox" style="display:none;">
        <h2>Recover</h2>
        <input id="forgotUser" placeholder="Username">
        <input id="forgotCode" placeholder="Passcode">
        <button onclick="recover()">Recover</button>
        <p onclick="showLogin()">Back to Login</p>
    </div>
</div>

<div id="app">
    <div class="topbar">
        <div id="welcomeUser"></div>
        <div>
            <button onclick="toggleDark()">ðŸŒ™</button>
            <button onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="controls">
        <button onclick="createNote()">New Note</button>
        <button id="exportBtn" onclick="exportExcel()">Export Excel</button>
        <button onclick="backupUser()">Backup</button>
        <input type="file" id="importFile"
        onchange="importBackup(event)" hidden>
        <button onclick="document.getElementById('importFile').click()">
        Import (Logged In)
        </button>
        <input type="text" id="searchInput"
        placeholder="Search..."
        oninput="renderNotes()">
    </div>

    <div class="notes-container" id="notesContainer"></div>
</div>

<script>

let currentUser = null;
let draggedId = null;

/* STORAGE */
function getUsers(){
    return JSON.parse(localStorage.getItem("users")) || {};
}
function saveUsers(users){
    localStorage.setItem("users", JSON.stringify(users));
}

/* EXPORT BUTTON LOGIC */
function updateExportButton(){
    if(!currentUser) return;
    let data = getUserData();
    let btn = document.getElementById("exportBtn");
    if(!btn) return;

    let hasValidContent = data.notes.some(n => n.content && n.content.trim() !== "");
    btn.disabled = !hasValidContent;
}

/* AUTH */
function register(){
    let u = document.getElementById("regUser").value.trim();
    let p = document.getElementById("regPass").value.trim();
    let c = document.getElementById("regCode").value.trim();
    if(!u || !p || !c) return alert("Fill all fields");

    let users = getUsers();
    if(users[u]) return alert("User exists");

    users[u] = { password: p, passcode: c, notes: [] };
    saveUsers(users);
    alert("Registered!");
    showLogin();
}

function login(){
    let u = document.getElementById("loginUser").value.trim();
    let p = document.getElementById("loginPass").value.trim();
    let users = getUsers();

    if(users[u] && users[u].password === p){
        currentUser = u;
        localStorage.setItem("loggedInUser", u);
        loadApp();
    } else {
        alert("Invalid credentials");
    }
}

function recover(){
    let u = document.getElementById("forgotUser").value.trim();
    let c = document.getElementById("forgotCode").value.trim();
    let users = getUsers();
    if(users[u] && users[u].passcode === c){
        alert("Password: " + users[u].password);
    } else alert("Invalid details");
}

function logout(){
    localStorage.removeItem("loggedInUser");
    location.reload();
}

function showRegister(){
    document.getElementById("loginBox").style.display="none";
    document.getElementById("registerBox").style.display="block";
}
function showLogin(){
    document.getElementById("registerBox").style.display="none";
    document.getElementById("forgotBox").style.display="none";
    document.getElementById("loginBox").style.display="block";
}
function showForgot(){
    document.getElementById("loginBox").style.display="none";
    document.getElementById("forgotBox").style.display="block";
}

/* APP */
function loadApp(){
    document.getElementById("authContainer").style.display="none";
    document.getElementById("app").style.display="block";
    document.getElementById("welcomeUser").innerText="Welcome, "+currentUser;
    renderNotes();
    updateExportButton();
}

/* USER DATA */
function getUserData(){
    let users = getUsers();
    if(!users[currentUser]){
        users[currentUser]={ password:"", passcode:"", notes:[] };
    }
    if(!users[currentUser].notes){
        users[currentUser].notes=[];
    }
    saveUsers(users);
    return users[currentUser];
}

function saveUserData(data){
    let users=getUsers();
    users[currentUser]=data;
    saveUsers(users);
}

/* BACKUP */
function backupUser(){
    if(!currentUser) return alert("Not logged in");
    let users=getUsers();
    let backupData={};
    backupData[currentUser]=users[currentUser];

    let blob=new Blob([JSON.stringify(backupData,null,2)],{type:"application/json"});
    let a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=currentUser+"_backup.json";
    a.click();
}

/* IMPORT (LOGGED IN) */
function importBackup(event){
    let file=event.target.files[0];
    if(!file) return;

    let reader=new FileReader();
    reader.onload=function(e){
        let imported=JSON.parse(e.target.result);
        let users=getUsers();
        if(imported[currentUser]){
            users[currentUser]=imported[currentUser];
            saveUsers(users);
            alert("Backup Imported!");
            renderNotes();
            updateExportButton();
        }else{
            alert("Invalid backup file for this user.");
        }
    };
    reader.readAsText(file);
}

/* GLOBAL IMPORT */
function globalImport(event){
    let file=event.target.files[0];
    if(!file) return;

    let reader=new FileReader();
    reader.onload=function(e){
        let imported=JSON.parse(e.target.result);
        let users=getUsers();
        Object.assign(users,imported);
        saveUsers(users);
        alert("Backup Imported Successfully! You can now login.");
    };
    reader.readAsText(file);
}

/* NOTES */
function createNote(){
    if(!currentUser) return;
    let data=getUserData();
    data.notes.push({
        id:Date.now(),
        content:"",
        color:"#fff9a8",
        created:""
    });
    saveUserData(data);
    renderNotes();
}

function renderNotes(){
    if(!currentUser) return;

    let container=document.getElementById("notesContainer");
    container.innerHTML="";
    let data=getUserData();
    let search=document.getElementById("searchInput")?.value?.toLowerCase()||"";

    data.notes
    .filter(n=>(n.content||"").toLowerCase().includes(search))
    .forEach(note=>{
        let div=document.createElement("div");
        div.className="note";
        div.style.background=note.color;
        div.draggable=true;

        div.innerHTML=`
<input type="text" value="${note.created||''}" oninput="updateDate(${note.id},this.value)">
<textarea oninput="updateNote(${note.id},this.value)">${note.content||''}</textarea>
<input type="color" value="${note.color}" onchange="changeColor(${note.id},this.value)">
<div class="actions">
<button onclick="deleteNote(${note.id})">ðŸ—‘</button>
</div>`;

        div.addEventListener("dragstart",()=>draggedId=note.id);
        div.addEventListener("dragover",(e)=>e.preventDefault());
        div.addEventListener("drop",()=>reorderNotes(draggedId,note.id));

        container.appendChild(div);
    });

    updateExportButton();
}

function updateNote(id,value){
    let data=getUserData();
    let note=data.notes.find(n=>n.id===id);
    if(note){
        note.content=value;
        saveUserData(data);
        updateExportButton();
    }
}

function updateDate(id,value){
    let data=getUserData();
    let note=data.notes.find(n=>n.id===id);
    if(note){
        note.created=value;
        saveUserData(data);
    }
}

function deleteNote(id){
    let data=getUserData();
    data.notes=data.notes.filter(n=>n.id!==id);
    saveUserData(data);
    renderNotes();
}

function changeColor(id,color){
    let data=getUserData();
    let note=data.notes.find(n=>n.id===id);
    if(note){
        note.color=color;
        saveUserData(data);
    }
}

function reorderNotes(id1,id2){
    let data=getUserData();
    let notes=data.notes;
    let i1=notes.findIndex(n=>n.id===id1);
    let i2=notes.findIndex(n=>n.id===id2);
    [notes[i1],notes[i2]]=[notes[i2],notes[i1]];
    saveUserData(data);
    renderNotes();
}

/* EXPORT */
function exportExcel(){
    let data=getUserData();
    let hasValidContent=data.notes.some(n=>n.content&&n.content.trim()!=="");
    if(!hasValidContent){
        alert("No valid note content to export.");
        return;
    }

    let csv="SNo,Created Date,Content\n";
    data.notes.forEach((n,index)=>{
        let created=n.created||"";
        let content=n.content?n.content.replace(/"/g,'""'):"";
        csv+=`${index+1},"${created}","${content}"\n`;
    });

    let blob=new Blob([csv],{type:"text/csv"});
    let a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=currentUser+"_notes_report.csv";
    a.click();
}

/* DARK MODE */
function toggleDark(){
    document.body.classList.toggle("dark");
    localStorage.setItem("darkMode",document.body.classList.contains("dark"));
}

/* AUTO LOGIN */
window.onload=function(){
    let u=localStorage.getItem("loggedInUser");
    if(u){
        currentUser=u;
        loadApp();
    }
    if(localStorage.getItem("darkMode")==="true"){
        document.body.classList.add("dark");
    }
};

</script>

</body>
</html>
