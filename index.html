<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Advanced Notes App</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>

body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,sans-serif;
    background:#f2f2f2;
    transition:0.3s;
}
body.dark{
    background:#1e1e1e;
    color:white;
}

/* AUTH */
.auth-container{
    display:flex;
    height:100vh;
    justify-content:center;
    align-items:center;
}
.auth-box{
    background:white;
    padding:30px;
    width:320px;
    border-radius:12px;
    box-shadow:0 10px 25px rgba(0,0,0,0.1);
}
body.dark .auth-box{
    background:#2a2a2a;
    color:white;
}
.auth-box input{
    width:100%;
    padding:10px;
    margin:8px 0;
    border-radius:6px;
    border:1px solid #ccc;
}
.auth-box button{
    width:100%;
    padding:10px;
    margin-top:8px;
    background:#007bff;
    border:none;
    color:white;
    border-radius:6px;
    cursor:pointer;
}
.auth-box p{
    text-align:center;
    cursor:pointer;
    color:#007bff;
    font-size:14px;
}

/* APP */
#app{ display:none; }

.topbar{
    background:#007bff;
    color:white;
    padding:12px 20px;
    display:flex;
    justify-content:space-between;
    align-items:center;
}

.controls{
    padding:15px 20px;
}
.controls button{
    margin-right:10px;
    padding:8px 12px;
}
.controls input{
    padding:6px;
}

.notes-container{
    padding:20px;
    display:flex;
    flex-wrap:wrap;
    gap:15px;
}

.note{
    width:220px;
    min-height:170px;
    padding:10px;
    border-radius:10px;
    box-shadow:0 5px 15px rgba(0,0,0,0.15);
    position:relative;
    cursor:grab;
}
body.dark .note{
    box-shadow:0 5px 15px rgba(255,255,255,0.1);
}
.note textarea{
    width:100%;
    border:none;
    background:transparent;
    resize:none;
    height:100px;
    outline:none;
}
body.dark textarea{ color:white; }

.note input[type="color"]{
    margin-top:5px;
}
.note .actions{
    position:absolute;
    bottom:5px;
    right:5px;
}
.note button{
    border:none;
    background:none;
    cursor:pointer;
    font-size:16px;
}
</style>
</head>

<body>

<!-- AUTH -->
<div class="auth-container" id="authContainer">

    <div class="auth-box" id="loginBox">
        <h2>Login</h2>
        <input id="loginUser" placeholder="Username">
        <input id="loginPass" type="password" placeholder="Password">
        <button onclick="login()">Login</button>

        <button onclick="document.getElementById('globalImportFile').click()">
        Import Backup
        </button>
        <input type="file" id="globalImportFile"
        onchange="globalImport(event)" hidden>

        <p onclick="showRegister()">Register</p>
        <p onclick="showForgot()">Forgot Password</p>
    </div>

    <div class="auth-box" id="registerBox" style="display:none;">
        <h2>Register</h2>
        <input id="regUser" placeholder="Username">
        <input id="regPass" type="password" placeholder="Password">
        <input id="regCode" placeholder="Passcode (Recovery)">
        <button onclick="register()">Register</button>
        <p onclick="showLogin()">Back to Login</p>
    </div>

    <div class="auth-box" id="forgotBox" style="display:none;">
        <h2>Recover</h2>
        <input id="forgotUser" placeholder="Username">
        <input id="forgotCode" placeholder="Passcode">
        <button onclick="recover()">Recover</button>
        <p onclick="showLogin()">Back to Login</p>
    </div>

</div>

<!-- APP -->
<div id="app">
    <div class="topbar">
        <div id="welcomeUser"></div>
        <div>
            <button onclick="toggleDark()">ðŸŒ™</button>
            <button onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="controls">
        <button onclick="createNote()">New Note</button>
        <button onclick="exportExcel()">Export Excel</button>
        <button onclick="backupUser()">Backup</button>
        <input type="file" id="importFile"
        onchange="importBackup(event)" hidden>
        <button onclick="document.getElementById('importFile').click()">
        Import (Logged In)
        </button>
        <input type="text" id="searchInput"
        placeholder="Search..."
        oninput="renderNotes()">
    </div>

    <div class="notes-container" id="notesContainer"></div>
</div>

<script>

let currentUser=null;
let draggedId=null;

/* STORAGE */
function getUsers(){
    return JSON.parse(localStorage.getItem("users"))||{};
}
function saveUsers(users){
    localStorage.setItem("users",JSON.stringify(users));
}

/* AUTH */
function register(){
    let u=regUser.value.trim();
    let p=regPass.value.trim();
    let c=regCode.value.trim();
    if(!u||!p||!c) return alert("Fill all fields");

    let users=getUsers();
    if(users[u]) return alert("User exists");

    users[u]={password:p,passcode:c,notes:[]};
    saveUsers(users);
    alert("Registered!");
    showLogin();
}

function login(){
    let u=loginUser.value.trim();
    let p=loginPass.value.trim();
    let users=getUsers();

    if(users[u] && users[u].password===p){
        currentUser=u;
        localStorage.setItem("loggedInUser",u);
        loadApp();
    } else alert("Invalid credentials");
}

function recover(){
    let u=forgotUser.value.trim();
    let c=forgotCode.value.trim();
    let users=getUsers();
    if(users[u] && users[u].passcode===c){
        alert("Password: "+users[u].password);
    } else alert("Invalid details");
}

function logout(){
    localStorage.removeItem("loggedInUser");
    location.reload();
}

function showRegister(){ loginBox.style.display="none"; registerBox.style.display="block"; }
function showLogin(){ registerBox.style.display="none"; forgotBox.style.display="none"; loginBox.style.display="block"; }
function showForgot(){ loginBox.style.display="none"; forgotBox.style.display="block"; }

/* GLOBAL IMPORT */
function globalImport(event){
    let file=event.target.files[0];
    if(!file) return;

    let reader=new FileReader();
    reader.onload=function(e){
        try{
            let backup=JSON.parse(e.target.result);

            if(!backup.username || !backup.password || !backup.notes){
                alert("Invalid backup file");
                return;
            }

            let users=getUsers();
            users[backup.username]={
                password:backup.password,
                passcode:backup.passcode,
                notes:backup.notes
            };
            saveUsers(users);

            alert("Account restored successfully!");
        }catch{
            alert("Invalid file format");
        }
    };
    reader.readAsText(file);
}

/* APP */
function loadApp(){
    authContainer.style.display="none";
    app.style.display="block";
    welcomeUser.innerText="Welcome, "+currentUser;
    renderNotes();
}

function getUserData(){
    let users = getUsers();

    if(!users[currentUser]){
        users[currentUser] = {
            password: "",
            passcode: "",
            notes: []
        };
        saveUsers(users);
    }

    if(!users[currentUser].notes){
        users[currentUser].notes = [];
        saveUsers(users);
    }

    return users[currentUser];
}

function saveUserData(data){
    let users=getUsers();
    users[currentUser]=data;
    saveUsers(users);
}

/* NOTES */
function createNote(){
let data = getUserData();
if(!data.notes) data.notes = [];

    data.notes.push({
        id:Date.now(),
        content:"",
        color:"#fff9a8",
        created:""

    });
    saveUserData(data);
    renderNotes();
}

function renderNotes(){
    notesContainer.innerHTML="";
    let data=getUserData();
    let search=document.getElementById("searchInput")?.value?.toLowerCase()||"";

    data.notes
    .filter(n=>n.content.toLowerCase().includes(search))
    .forEach(note=>{
        let div=document.createElement("div");
        div.className="note";
        div.style.background=note.color;
        div.draggable=true;

div.innerHTML=`
<input type="text" 
placeholder="Enter date (dd/mm/yyyy or mm/dd/yyyy)"
value="${note.created || ''}"
oninput="updateDate(${note.id}, this.value)">

<textarea oninput="updateNote(${note.id},this.value)">
${note.content}</textarea>

<input type="color" value="${note.color}"
onchange="changeColor(${note.id},this.value)">

<div class="actions">
<button onclick="deleteNote(${note.id})">ðŸ—‘</button>
</div>
`;


        div.addEventListener("dragstart",()=> draggedId=note.id);
        div.addEventListener("dragover",(e)=> e.preventDefault());
        div.addEventListener("drop",()=> reorderNotes(draggedId,note.id));

        notesContainer.appendChild(div);
    });
}

function updateNote(id,value){
    let data=getUserData();
    let note=data.notes.find(n=>n.id===id);
    note.content=value;
    saveUserData(data);
}

function updateDate(id,value){
    let data = getUserData();
    let note = data.notes.find(n => n.id === id);

    if(note){
        note.created = value;   // store exactly what user types
        saveUserData(data);
    }
}


function deleteNote(id){
    let data=getUserData();
    data.notes=data.notes.filter(n=>n.id!==id);
    saveUserData(data);
    renderNotes();
}

function changeColor(id,color){
    let data=getUserData();
    let note=data.notes.find(n=>n.id===id);
    note.color=color;
    saveUserData(data);
}

function reorderNotes(id1,id2){
    let data=getUserData();
    let notes=data.notes;
    let i1=notes.findIndex(n=>n.id===id1);
    let i2=notes.findIndex(n=>n.id===id2);
    [notes[i1],notes[i2]]=[notes[i2],notes[i1]];
    saveUserData(data);
    renderNotes();
}

/* CLEAN EXCEL EXPORT */
function exportExcel(){
    let data = getUserData();
    let csv = "SNo,Created Date,Content\n";

    data.notes.forEach((n, index) => {
        let created = n.created && n.created.trim() !== "" ? n.created : "";
        let content = n.content ? n.content.replace(/"/g,'""') : "";

        csv += `${index + 1},"${created}","${content}"\n`;
    });

    let blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
    let a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = currentUser+"_notes_report.csv";
    a.click();
}


    let blob = new Blob([csv], {type:"text/csv"});
    let a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = currentUser+"_notes_report.csv";
    a.click();
}

/* CLEAN BACKUP FILE */
function backupUser(){
    let data=getUserData();
    let backup={
        username:currentUser,
        password:data.password,
        passcode:data.passcode,
        notes:data.notes
    };

    let blob=new Blob(
        [JSON.stringify(backup,null,2)],
        {type:"application/json"}
    );

    let a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=currentUser+"_backup.json";
    a.click();
}

function importBackup(event){
    let file=event.target.files[0];
    let reader=new FileReader();
    reader.onload=function(e){
        let backup=JSON.parse(e.target.result);
        let users=getUsers();
        users[currentUser]={
            password:backup.password,
            passcode:backup.passcode,
            notes:backup.notes
        };
        saveUsers(users);
        renderNotes();
        alert("Backup imported");
    };
    reader.readAsText(file);
}

/* DARK MODE */
function toggleDark(){
    document.body.classList.toggle("dark");
    localStorage.setItem("darkMode",
    document.body.classList.contains("dark"));
}

/* AUTO LOGIN */
window.onload=function(){
    let u=localStorage.getItem("loggedInUser");
    if(u){
        currentUser=u;
        loadApp();
    }
    if(localStorage.getItem("darkMode")==="true"){
        document.body.classList.add("dark");
    }
}

</script>
</body>
</html>
